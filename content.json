{"pages":[{"title":"","date":"2018-11-16T02:08:44.000Z","path":"about/index.html","text":"此博客由HEXO构建，采用的是Wikitten主题"},{"title":"LIIHAG","date":"2018-11-16T02:08:44.000Z","path":"home/index.html","text":"由于本人采用为知笔记来管理知识，因此博客会较少更新"}],"posts":[{"title":"RK3399 Android 音频驱动总结","date":"2019-02-25T12:07:44.000Z","path":"wiki/Android/驱动/Rk3399 Android音频驱动总结/","text":"整体音频驱动框架音频硬件设备驱动，由三大部分组成，分别是 Machine、Platform、Code snd_card： snd_card可以说是整个ALSA音频驱动最顶层的一个结构，整个声卡的软件逻辑结构开始于该结构，几乎所有与声音相关的逻辑设备都是在snd_card的管理之下，声卡驱动的第一个动作通常就是创建一个snd_card结构体。 Machine驱动中通常会注册snd_card。Machine中会绑定Platform和codec Platform驱动通常对应的是CPU端的I2S操作。 Codec驱动通常对应的是单独的codec，Codec驱动与平台无关。 一次音频设置的大体流程为： 设置machine–》machine分别设置Platform和Codec Dai的概念：Platform驱动和Codec驱动，通常通过Dai Driver来和Machine通信。 Machine驱动一般来说Machine对应的是一个linux platform 设备。 Machine驱动中会初始化一个snd_card结构体，snd_card结构体中有个关键的snd_soc_dai_link。snd_soc_dai_link就是用来绑定codec和Platform使用的。 在初始化snd_card后，Machine会通过snd_soc_register_card来注册一个声卡设备（snd_card）。 Platform驱动Platform驱动通常对应CPU端的I2S或其他音频格式接口。也就是用来设置CPU内部操作的，可能会涉及到相关的dma操作。 snd_soc_dai_driver： 123456789101112131415161718192021222324252627282930struct snd_soc_dai_driver &#123; /* DAI description */ const char *name;//ALOS就是通过这name来绑定machine中的dailink， unsigned int id; unsigned int base; /* DAI driver callbacks */ int (*probe)(struct snd_soc_dai *dai);//初次绑定dai时执行的操作 int (*remove)(struct snd_soc_dai *dai); int (*suspend)(struct snd_soc_dai *dai); int (*resume)(struct snd_soc_dai *dai); /* compress dai */ int (*compress_new)(struct snd_soc_pcm_runtime *rtd, int num); /* DAI is also used for the control bus */ bool bus_control; /* ops */ const struct snd_soc_dai_ops *ops;//实际上主要的相关操作：设置时钟，波特率等 /* DAI capabilities */ struct snd_soc_pcm_stream capture;//实际的capture流的能力，如果不设此值，表示没有capture的pcm节点 struct snd_soc_pcm_stream playback//实际的palyback流的能力，如果不设此值，表示没有capture的pcm节点 unsigned int symmetric_rates:1; unsigned int symmetric_channels:1; unsigned int symmetric_samplebits:1; /* probe ordering - for components with runtime dependencies */ int probe_order; int remove_order;&#125;; machine 通过snd_soc_add_platform来注册snd_soc_dai_driver CODEC驱动codec驱动同样需要实例化上面说的snd_soc_dai_driver来与machine联系，同时还要注册一个snd_soc_codec_driver驱动来实现codec自身的相关操作。 snd_soc_dai_driver和snd_soc_codec_driver通过snd_soc_register_codec来注册绑定。 RK3399的音频驱动Machine驱动：simple_cardRk3399比较推荐使用simple card来充当machine的角色。对应驱动文件路径：\\sound\\soc\\generic\\simple-card.c。 simple-card的相关dts配置可以参考内核文档，需要注意的是： 1.在CPU或codec的子节点中，如果指定了clock设备，那么该在子节点被启动或停用时此clock会自动被使能或失能。无需额外操作。这个clock通常是用于给外设提供mclk，所以通常挂载codec的节点下。 2.默认是CPU为I2S主设备，除非指定了bitclock-master和frame-master 3.默认只有一个dailink，如果只有一个dailink，则需要在每个属性或节点前添加simple-audio-card,前缀。多个dailink则不能添加 4.simple card同样支持tdm格式 Platform驱动： rockchip_i2s实际上在rockchip i2s驱动中，是通过devm_snd_soc_register_component封装的snd_soc_add_platform 此外，还通过devm_snd_dmaengine_pcm_register注册了一个dma的驱动 Codec 驱动：dummy_codecdummy_codec为一个基础的codec代码，我在此基础上修改从而实现了讯飞模块和ti模块的纯数字I2S音频输入输出的驱动。 I2S相关知识I2S有3个主要信号： SCLK（BCLK）：串行时钟，也叫位时钟（BCLK），即对应数字音频的每一位数据，SCLK都有1个脉冲。** LRCK：帧时钟，用于切换左右声道的数据。LRCK的频率=采样频率。通常有8K/16K/32K /44.1K等采样率 SDATA：串行数据，就是用二进制补码表示的音频数据 MCLK：主时钟，也叫系统时钟（Sys Clock）。为了使系统间能够更好地同步，MCLK的频率与LRCK存在一个倍数关系。某些模块实际上不需要输入MCLK，讯飞模块就不需要 通常情况下： ​ SCLK的频率=2×采样频率×采样位数 根据SDATA数据相对于LRCK和SCLK的位置不同，I2S格式分为： 左对齐（较少使用） I2S格式（即飞利浦规定的格式） 右对齐（也叫日本格式、普通格式）。","tags":[{"name":"rk3399","slug":"rk3399","permalink":"/tags/rk3399/"},{"name":"音频驱动","slug":"音频驱动","permalink":"/tags/音频驱动/"}],"categories":[{"name":"Android","slug":"Android","permalink":"/categories/Android/"},{"name":"驱动","slug":"Android/驱动","permalink":"/categories/Android/驱动/"}]},{"title":"LIIHAG","date":"2018-11-16T02:08:44.000Z","path":"wiki/首页/","text":"由于本人采用为知笔记来管理知识，因此博客会较少更新","tags":[],"categories":[]},{"title":"hexo相关常用操作","date":"2018-11-16T02:08:44.000Z","path":"wiki/备忘/hexo相关常用操作/","text":"常用操作hexo 生成页面1hexo g 启动hexo本地服务器1hexo s 部署1hexo d 实际上不需要使用hexo其他指令来写文章，每次直接在source/_posts目录下新建md文档，然后直接hexo g 生成hexo d部署即可。这种方式需要手动修改tags和categories。 相关概念1.在我采用的这个主题中，categories需要理解为导航。 2.网页上面的菜单栏（主页、关于），对应的是config.yml中的menu。实际上点击主页会显示所有主页目录下的所有文章，而我故意将主页目录下只放一个index.md，所以看上去主页就是一个页面。 3.关于首页，网页首页的配置在主题的config.yml中 1default_index_file: 首页.md # if this, it will display at site index instead of default index page 需要注意的是，这里的首页和导航栏上面的首页不一样。但我部署时会故意将这个和导航栏的那个首页同步。这样的显示更友好 4.一篇文章可以有多个tag，如下此文章就可以同时有两个tag了： 123tags：- hexo- blog 5.注意categories是分层级的，如下实际的显示是在导航栏里分了两层。 123categories: - 2019- 01 6.每篇文章的头部配置中，toc: true 就会出现一个全局的目录 相关链接1.hexo-theme-Wikitten 主题 2.hexo官方文档","tags":[{"name":"hexo","slug":"hexo","permalink":"/tags/hexo/"}],"categories":[{"name":"备忘","slug":"备忘","permalink":"/categories/备忘/"}]}]}